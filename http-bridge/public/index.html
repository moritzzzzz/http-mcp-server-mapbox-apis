<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapbox AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .message {
            transition: all 0.3s ease;
        }
        .typing-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #9ca3af;
            animation: typing 1.4s infinite;
            margin: 0 1px;
        }
        .typing-indicator:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-indicator:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }
        .scrollbar-thin {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 #f1f5f9;
        }
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto max-w-4xl h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-blue-600 text-white p-4 shadow-lg">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-map-marked-alt text-2xl"></i>
                    <div>
                        <h1 class="text-xl font-bold">Mapbox AI Assistant</h1>
                        <p class="text-blue-100 text-sm">UI is powered by Claude Sonnet 4</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="status-indicator" class="flex items-center space-x-2">
                        <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                        <span class="text-sm">Connected</span>
                    </div>
                    <button id="clear-chat" class="bg-blue-700 hover:bg-blue-800 px-3 py-1 rounded text-sm transition-colors">
                        <i class="fas fa-trash mr-1"></i> Clear
                    </button>
                </div>
            </div>
        </header>

        <!-- Chat Messages -->
        <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 scrollbar-thin">
            <!-- Welcome Message -->
            <div class="message bg-white rounded-lg p-4 shadow-sm border-l-4 border-blue-500">
                <div class="flex items-start space-x-3">
                    <div class="bg-blue-100 rounded-full p-2 flex-shrink-0">
                        <i class="fas fa-robot text-blue-600"></i>
                    </div>
                    <div class="flex-1">
                        <div class="font-semibold text-gray-800 mb-1">Mapbox AI Assistant</div>
                        <div class="text-gray-600">
                            Welcome! I'm your AI assistant with access to Mapbox services. I can help you with:
                            <ul class="mt-2 space-y-1 text-sm">
                                <li>üó∫Ô∏è <strong>Geocoding:</strong> Convert addresses to coordinates and vice versa</li>
                                <li>üõ£Ô∏è <strong>Directions:</strong> Get routes for driving, walking, or cycling</li>
                                <li>üìç <strong>Static Maps:</strong> Generate custom map images with markers</li>
                                <li>‚è±Ô∏è <strong>Matrix:</strong> Calculate travel times and distances between multiple points</li>
                            </ul>
                            <div class="mt-3 text-sm text-gray-500">
                                Try asking: "Find the coordinates for Times Square" or "Get directions from New York to Boston"
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="border-t bg-white p-4">
            <form id="chat-form" class="flex space-x-4">
                <div class="flex-1 relative">
                    <input 
                        type="text" 
                        id="message-input" 
                        placeholder="Ask me anything about maps and locations..."
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none pr-12"
                        maxlength="1000"
                    >
                    <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm" id="char-count">
                        0/1000
                    </div>
                </div>
                <button 
                    type="submit" 
                    id="send-button"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors flex items-center space-x-2 disabled:bg-gray-400 disabled:cursor-not-allowed"
                >
                    <span>Send</span>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>

    <script>
        class MapboxChatInterface {
            constructor() {
                this.conversationHistory = [];
                this.isLoading = false;
                
                this.initializeEventListeners();
                this.loadTools();
            }

            initializeEventListeners() {
                const form = document.getElementById('chat-form');
                const input = document.getElementById('message-input');
                const clearButton = document.getElementById('clear-chat');

                form.addEventListener('submit', (e) => this.handleSubmit(e));
                input.addEventListener('input', (e) => this.updateCharCount(e));
                clearButton.addEventListener('click', () => this.clearChat());

                // Auto-resize input and focus
                input.focus();
            }

            updateCharCount(event) {
                const count = event.target.value.length;
                document.getElementById('char-count').textContent = `${count}/1000`;
            }

            async loadTools() {
                try {
                    const response = await fetch('/api/tools');
                    const data = await response.json();
                    console.log('Available tools:', data.tools);
                } catch (error) {
                    console.error('Failed to load tools:', error);
                }
            }

            async handleSubmit(event) {
                event.preventDefault();
                
                if (this.isLoading) return;

                const input = document.getElementById('message-input');
                const message = input.value.trim();
                
                if (!message) return;

                this.isLoading = true;
                this.updateSendButton(true);
                
                // Add user message to chat
                this.addMessage(message, 'user');
                
                // Clear input
                input.value = '';
                this.updateCharCount({ target: { value: '' } });
                
                // Show typing indicator
                const typingId = this.addTypingIndicator();
                
                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: message,
                            conversationHistory: this.conversationHistory
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    
                    // Remove typing indicator
                    this.removeTypingIndicator(typingId);
                    
                    // Update conversation history
                    this.conversationHistory = data.conversationHistory;
                    
                    // Add assistant response
                    this.addMessage(data.response, 'assistant');
                    
                } catch (error) {
                    console.error('Chat error:', error);
                    this.removeTypingIndicator(typingId);
                    this.addMessage('Sorry, I encountered an error processing your request. Please try again.', 'assistant', true);
                } finally {
                    this.isLoading = false;
                    this.updateSendButton(false);
                    input.focus();
                }
            }

            addMessage(content, sender, isError = false) {
                const container = document.getElementById('chat-container');
                const messageDiv = document.createElement('div');
                
                const isUser = sender === 'user';
                const bgColor = isUser ? 'bg-blue-500 text-white' : (isError ? 'bg-red-50 border-l-4 border-red-500' : 'bg-white');
                const alignment = isUser ? 'ml-auto max-w-2xl' : 'mr-auto max-w-3xl';
                
                messageDiv.className = `message ${bgColor} ${alignment} rounded-lg p-4 shadow-sm`;
                
                if (isUser) {
                    messageDiv.innerHTML = `
                        <div class="flex items-start space-x-3 justify-end">
                            <div class="text-right">
                                <div class="font-semibold mb-1">You</div>
                                <div>${this.escapeHtml(content)}</div>
                            </div>
                            <div class="bg-white bg-opacity-20 rounded-full p-2 flex-shrink-0">
                                <i class="fas fa-user"></i>
                            </div>
                        </div>
                    `;
                } else {
                    const iconClass = isError ? 'fas fa-exclamation-triangle text-red-600' : 'fas fa-robot text-blue-600';
                    const iconBg = isError ? 'bg-red-100' : 'bg-blue-100';
                    
                    messageDiv.innerHTML = `
                        <div class="flex items-start space-x-3">
                            <div class="${iconBg} rounded-full p-2 flex-shrink-0">
                                <i class="${iconClass}"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-semibold text-gray-800 mb-1">Assistant</div>
                                <div class="text-gray-600">${this.formatAssistantMessage(content)}</div>
                            </div>
                        </div>
                    `;
                }
                
                container.appendChild(messageDiv);
                
                // Add event listeners to any Mapbox images that were just added
                const mapboxImages = messageDiv.querySelectorAll('.mapbox-image');
                mapboxImages.forEach(img => {
                    img.addEventListener('load', () => {
                        console.log('Mapbox image loaded successfully:', img.src);
                        this.scrollToBottom(); // Re-scroll after image loads
                    });
                    img.addEventListener('error', () => {
                        console.error('Mapbox image failed to load:', img.src);
                    });
                });
                
                this.scrollToBottom();
            }

            formatAssistantMessage(content) {
                console.log('formatAssistantMessage received:', content); // Debug logging
                
                if (Array.isArray(content)) {
                    return content.map(block => {
                        console.log('Processing block:', block); // Debug logging
                        if (block.type === 'text') {
                            return this.formatText(block.text);
                        }
                        return '';
                    }).join('');
                }
                
                if (typeof content === 'string') {
                    return this.formatText(content);
                }
                
                console.log('Content is not string or array, stringifying:', content); // Debug logging
                return this.escapeHtml(JSON.stringify(content));
            }

            formatText(text) {
                console.log('Original text:', text); // Debug logging
                
                // First escape HTML, then apply formatting
                let formattedText = this.escapeHtml(text)
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/\n/g, '<br>')
                    .replace(/```([\s\S]*?)```/g, '<pre class="bg-gray-100 p-2 rounded mt-2 mb-2 text-sm overflow-x-auto"><code>$1</code></pre>')
                    .replace(/`(.*?)`/g, '<code class="bg-gray-100 px-1 rounded text-sm">$1</code>');
                
                console.log('After basic formatting:', formattedText); // Debug logging
                
                // Convert Mapbox image URLs to actual images - more permissive regex
                formattedText = formattedText.replace(
                    /https:\/\/api\.mapbox\.com\/styles\/v1\/[^\s<>"']+/g,
                    (url) => {
                        console.log('Found Mapbox URL:', url); // Debug logging
                        return `<div class="mt-3 mb-3"><img src="${url}" alt="Mapbox Map" class="mapbox-image max-w-full h-auto rounded-lg border shadow-md" style="max-height: 400px;" loading="lazy" /></div>`;
                    }
                );
                
                // Also match markdown image syntax ![alt](url)
                formattedText = formattedText.replace(
                    /!\[([^\]]*)\]\((https:\/\/api\.mapbox\.com\/[^)]+)\)/g,
                    (match, alt, url) => {
                        console.log('Found markdown image:', alt, url); // Debug logging
                        return `<div class="mt-3 mb-3"><img src="${url}" alt="${alt}" class="mapbox-image max-w-full h-auto rounded-lg border shadow-md" style="max-height: 400px;" loading="lazy" /></div>`;
                    }
                );
                
                console.log('Final formatted text:', formattedText); // Debug logging
                return formattedText;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            addTypingIndicator() {
                const container = document.getElementById('chat-container');
                const typingDiv = document.createElement('div');
                const typingId = 'typing-' + Date.now();
                
                typingDiv.id = typingId;
                typingDiv.className = 'message bg-white rounded-lg p-4 shadow-sm mr-auto max-w-3xl';
                
                typingDiv.innerHTML = `
                    <div class="flex items-start space-x-3">
                        <div class="bg-blue-100 rounded-full p-2 flex-shrink-0">
                            <i class="fas fa-robot text-blue-600"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-gray-800 mb-1">Assistant</div>
                            <div class="text-gray-600 flex items-center space-x-1">
                                <span>Thinking</span>
                                <div class="typing-indicator"></div>
                                <div class="typing-indicator"></div>
                                <div class="typing-indicator"></div>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(typingDiv);
                this.scrollToBottom();
                
                return typingId;
            }

            removeTypingIndicator(typingId) {
                const element = document.getElementById(typingId);
                if (element) {
                    element.remove();
                }
            }

            updateSendButton(isLoading) {
                const button = document.getElementById('send-button');
                const input = document.getElementById('message-input');
                
                button.disabled = isLoading;
                input.disabled = isLoading;
                
                if (isLoading) {
                    button.innerHTML = `
                        <span>Sending</span>
                        <i class="fas fa-spinner fa-spin"></i>
                    `;
                } else {
                    button.innerHTML = `
                        <span>Send</span>
                        <i class="fas fa-paper-plane"></i>
                    `;
                }
            }

            clearChat() {
                const container = document.getElementById('chat-container');
                const messages = container.querySelectorAll('.message');
                
                // Keep only the welcome message (first message)
                messages.forEach((message, index) => {
                    if (index > 0) {
                        message.remove();
                    }
                });
                
                this.conversationHistory = [];
            }

            scrollToBottom() {
                const container = document.getElementById('chat-container');
                container.scrollTop = container.scrollHeight;
            }
        }

        // Initialize the chat interface when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new MapboxChatInterface();
        });
    </script>
</body>
</html>